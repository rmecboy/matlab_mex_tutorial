#include "user_config.h"
#include <stdlib.h>  // 包含 srand() 和 rand()
#include <time.h>    // 包含 time()

// 预计算模型参数（需从MATLAB生成后填入）
const TinyMPC_Model model = {
    .A = {0, 1.0, 0,   0,                                  0,   0,                                  0,   0,       0,   0,
0,   0, 0,   0,  -9.752694243766134363227138237562,   0,  -9.752694243766134363227138237562,   0,       0,   0,
0,   0, 0, 1.0,                                  0,   0,                                  0,   0,       0,   0,
0,   0, 0,   0, -8.3010100438507326003900743671693,   0,  8.3010100438507326003900743671693,   0,       0,   0,
0,   0, 0,   0,                                  0, 1.0,                                  0,   0,       0,   0,
0,   0, 0,   0,  114.18258424736831102563883177936,   0,   10.03594681303659363891256361967,   0,       0,   0,
0,   0, 0,   0,                                  0,   0,                                  0, 1.0,       0,   0,
0,   0, 0,   0,   10.03594681303659363891256361967,   0,  114.18258424736831102563883177936,   0,       0,   0,
0,   0, 0,   0,                                  0,   0,                                  0,   0,       0, 1.0,
0,   0, 0,   0, -12.026065717438736868416526704095,   0, -12.026065717438736868416526704095,   0, 26.0292,   0},
    .B = {                                 0,                                  0,                                   0,                                  0,
 3.6804434913993673283982843713602,  3.6804434913993673283982843713602,  -0.8307152159053037276947861755616, -0.8307152159053037276947861755616,
                                 0,                                  0,                                   0,                                  0,
 -13.80586816625721979789886972867,   13.80586816625721979789886972867, -0.70706362554299262423995742210536, 0.70706362554299262423995742210536,
                                 0,                                  0,                                   0,                                  0,
-20.515237216129406760956044308841, -14.424900535164788095698895631358,   9.7258468024164432819134162855335, 0.85484210980312558270099998480873,
                                 0,                                  0,                                   0,                                  0,
-14.424900535164788095698895631358, -20.515237216129406760956044308841,  0.85484210980312558270099998480873,  9.7258468024164432819134162855335,
                                 0,                                  0,                                   0,                                  0,
0.89595730199857881448366470067413, 0.89595730199857881448366470067413,  -7.6910231705465248452924242883455, -7.6910231705465248452924242883455},
    .K_inf = { -0.00000000000000034476595785093534194930639661125,   0.0000000000000010626377091006625419055755451021, -0.0000000000000025381292161601381232923924295216, 0.00000000000000088595226612034855625730380650794,  -1.596643769177536142933604423888, -0.0000000000000080880655639158894707117097099382, -1.5966437692483563814960234594764, -0.0000000000000083154437317994621340548385724851, -0.53099161805633066091303362554754, 0.00000000000000095435911016742562301754301322991,
 0.00000000000000048746931464941910654998702418895,  -0.0000000000000024186911491264959497747143491813,  0.0000000000000087680294691160702183694647030076,  -0.000000000000001835353474824012527510357417483, -1.5966437692483264054743585802498,  -0.000000000000017305053649322614577507997868182, -1.5966437691775074991795690948493,  -0.000000000000017419395547345296708568627812709, -0.53099161805633154909145332567277,  -0.000000000000011556881049000360158404891924538,
0.000000000000000030975949812928429875238041801153, -0.00000000000000014249563732875978875927315738682,  -0.000000000000019001605736395586366863324127238, -0.0000000000000028707390389705266161531701016716,  6.4659970856729387378436513245106,  0.0000000000000069547203497065700414684670235459, -5.2741200142005508766374077822547,  0.0000000000000063641449109676246876951499966785,  -1.7540002841712376557836705615046,  0.0000000000000028982999021996358838650205886732,
 0.00000000000000045223726579148793799640312362353,  -0.0000000000000016416092798083010780556704338498,   0.000000000000042940627946228165855749003673145,  0.0000000000000027532718278274817355643580100071, -5.2741200142005437712100501812529,   -0.00000000000004165562444658390392714263451294,  6.4659970856729414023789104248863,  -0.000000000000041548691188193812299025598895101,  -1.7540002841712407644081395119429,  -0.000000000000017313174610893102973759448943425
 
 },
    .C1 = { 
 0.00000027388974109273828857788837289056, -0.00000023290334777147595982720279343681, 0.000000052379772413558327444537207487688, 0.000000053586197178193610779955096496893,
-0.00000023290334777147611864588040361812,  0.00000027388974109272738302869247377369, 0.000000053586197178186391147568733671347, 0.000000052379772413560445026905343238535,
0.000000052379772413560782516595264873827, 0.000000053586197178183929458065775860987,   0.0000036305629597861838074514696100836,  -0.0000031858340912512432640364083008544,
 0.00000005358619717819075866120301365747,  0.00000005237977241356316479675941759353,  -0.0000031858340912512424170034610465541,   0.0000036305629597861914307479948987867
 
 },
    .C2 = { 
  0, -0.00000000000000012379907000070246079471047692612,   0, -0.000000000000011787589008825859125082698035431,   0, -0.00000000000000072911783245586776709451624611954,   0, 0.00000000000000060246406398336230208371748187163,   0,    0.0000000000000035885479229845494139276224055845,
1.0,   0.0000000000000035087949558955731391925363521225,   0,   0.00000000000004912273598722346628144649970248,   0,   -0.000000000000010299907095532791423847315946564,   0,   -0.00000000000001820372778209767431442302739301,   0,    -0.000000000000012506626274895685112709775935152,
  0,  -0.0000000000000030422858344559963327593657672484,   0,  -0.00000000000019988843659757460435014493963932,   0,     0.00000000000022250687942895543936083838700381,   0,   -0.00000000000025812465327880619223517429335885,   0,      0.00000000000017853384987369157897012403084298,
  0,   0.0000000000000033966356996336039813891042250552, 1.0,  0.000000000000033593454785985382659849643307812,   0,     0.00000000000001726748498500290240585180053543,   0,  -0.000000000000049196809979863562958711733148657,   0, -0.000000000000000052820097216314828944444776476244,
  0,                  2.9901305119608121430019309627824,   0,        -0.00000028193758261352286353940144181252,   0,                0.016873811706375363428378477692604,   0,               0.016870261751039450359712645877153,   0,                0.0017377431323080116953860851936042,
  0,     0.00000000000006463137129574518783903141184205,   0,   0.00000000000016161912902764887652133895967477, 1.0,    -0.00000000000044758382409832086199969813800106,   0,  -0.000000000000072495787925443147907431422708044,   0,      -0.0000000000002441343068683749648827668311423,
  0,                  2.9901305119608121430019309627824,   0,         0.00000028193676726573357882443815469742,   0,                0.016870261750899118169400026090443,   0,               0.016873811706503261120815295726061,   0,                0.0017377431322742609154374804347754,
  0,    0.000000000000065487283769921008533065943127621,   0,   0.00000000000015956538215970412693379232730762,   0,    -0.00000000000044824547646596583883805841669589, 1.0,  -0.000000000000078656614277845235903024336361549,   0,     -0.00000000000024754784349540346830368282303313,
  0,                 0.99441983979953507688520630836138,   0,  0.000000000000014003084735270337387732574142882,   0,               0.0056110790897892278555891820701618,   0,              0.0056110790898121600325798574715463,   0,               0.00057798158283972611570789013057947,
  0,    0.000000000000027047327106316482414349688969173,   0,   0.00000000000018701933068065057208227653316064,   0,    -0.00000000000016051634621858863189280541325479,   0,  -0.000000000000057417925834045644084981831299582, 1.0,     -0.00000000000010136572843438904731882905092368
 
},
    .Q = { 
350.0,     0,      0,   0,      0,     0,      0,     0,      0,   0,
    0, 2500.0,      0,   0,      0,     0,      0,     0,      0,   0,
    0,     0, 5000.0,   0,      0,     0,      0,     0,      0,   0,
    0,     0,      0, 1.0,      0,     0,      0,     0,      0,   0,
    0,     0,      0,   0, 1000.0,     0,      0,     0,      0,   0,
    0,     0,      0,   0,      0, 800.0,      0,     0,      0,   0,
    0,     0,      0,   0,      0,     0, 1000.0,     0,      0,   0,
    0,     0,      0,   0,      0,     0,      0, 800.0,      0,   0,
    0,     0,      0,   0,      0,     0,      0,     0, 20000.0,   0,
    0,     0,      0,   0,      0,     0,      0,     0,      0, 1.0},
    .R = { 
0.01,   0,    0,    0,
  0, 0.01,    0,    0,
  0,   0, 0.005,    0,
  0,   0,    0, 0.005}
};

TinyMPC_Controller ctrl = {0};
float x_ref[N_STATE] = { 0.0f, 0.0f, 0.0f, 0.0f, 0.0f, 0.0f, 0.0f, 0.0f, 0.0f, 0.0f};
float x_current[N_STATE] = {0, 3.5f, 0, 0, 0.25f, 0, -0.25f, 0, 0.3f, 0};
float u[N_INPUT] = {0};
     TinyMPC_Constraints constraints = {
        .x2_max = 3.0f,
        .x5_max = 0.3f,
        .x7_max = 0.3f,
        .x9_max = 0.2f
    };

uint8_t task_init(void)
{
    // 初始化控制器
    tinympc_init(&ctrl, &model, 12.0f, &constraints); // 新增约束参数
    tinympc_set_reference(&ctrl, x_ref);
      // 初始化随机种子
    srand(time(NULL));

    
   
}

void task_main()
{
    x_ref[2] = 2.5 ;
     // 更新参考轨迹到控制器
    tinympc_set_reference(&ctrl, x_ref);

    // 1. 计算控制输入
    tinympc_control(&ctrl, x_current, u);
    
    // 2. 打印当前状态和控制输入
    // mexPrintf("Step %d:\n", step);
    // mexPrintf("  State x9: %.3f\n", x_current[8]);
    // mexPrintf("  Control u: [%.3f, %.3f, %.3f, %.3f]\n", 
    //         u[0], u[1], u[2], u[3]);
    
    // 3. 更新状态（模拟传感器数据）
    tinympc_state_update(x_current, ctrl.model.A, ctrl.model.B, u, 0.005f);

}