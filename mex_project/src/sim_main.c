#include "user_config.h"

// 预计算模型参数（需从MATLAB生成后填入）
const TinyMPC_Model model = {
    .A = {0, 1.0, 0,   0,                                  0,   0,                                  0,   0,       0,   0,
0,   0, 0,   0,  -9.752694243766134363227138237562,   0,  -9.752694243766134363227138237562,   0,       0,   0,
0,   0, 0, 1.0,                                  0,   0,                                  0,   0,       0,   0,
0,   0, 0,   0, -8.3010100438507326003900743671693,   0,  8.3010100438507326003900743671693,   0,       0,   0,
0,   0, 0,   0,                                  0, 1.0,                                  0,   0,       0,   0,
0,   0, 0,   0,  114.18258424736831102563883177936,   0,   10.03594681303659363891256361967,   0,       0,   0,
0,   0, 0,   0,                                  0,   0,                                  0, 1.0,       0,   0,
0,   0, 0,   0,   10.03594681303659363891256361967,   0,  114.18258424736831102563883177936,   0,       0,   0,
0,   0, 0,   0,                                  0,   0,                                  0,   0,       0, 1.0,
0,   0, 0,   0, -12.026065717438736868416526704095,   0, -12.026065717438736868416526704095,   0, 26.0292,   0},
    .B = {                                 0,                                  0,                                   0,                                  0,
 3.6804434913993673283982843713602,  3.6804434913993673283982843713602,  -0.8307152159053037276947861755616, -0.8307152159053037276947861755616,
                                 0,                                  0,                                   0,                                  0,
 -13.80586816625721979789886972867,   13.80586816625721979789886972867, -0.70706362554299262423995742210536, 0.70706362554299262423995742210536,
                                 0,                                  0,                                   0,                                  0,
-20.515237216129406760956044308841, -14.424900535164788095698895631358,   9.7258468024164432819134162855335, 0.85484210980312558270099998480873,
                                 0,                                  0,                                   0,                                  0,
-14.424900535164788095698895631358, -20.515237216129406760956044308841,  0.85484210980312558270099998480873,  9.7258468024164432819134162855335,
                                 0,                                  0,                                   0,                                  0,
0.89595730199857881448366470067413, 0.89595730199857881448366470067413,  -7.6910231705465248452924242883455, -7.6910231705465248452924242883455},
    .K_inf = { 
-0.000000000000000028555535694248747933053368967503, -0.000000000000000073030737358529842349145585150258,  0.0000000000000034426400450276612679824815253166, -0.00000000000000077711761217075443539546433108006, -1.5966832696054786833173011473264,   0.000000000000013276158900073957445419890272433,  -1.596683254923838779504308149626,  0.000000000000011392798295951163880285628950555, -0.53100454155699849945193591338466, 0.0000000000000062376895142066164410369565269631,
-0.000000000000000065130780446870319360553773469646,   0.00000000000000028146277580807458430084944836045, -0.0000000000000055307545579821318251311321650853,   0.0000000000000037846207147068839626553426807823, -1.5966832549237921501372738930513,  0.0000000000000090673603447164934686027949920273, -1.5966832696054309437272422655951, 0.0000000000000090135383960255401026967026943974,  -0.5310045415569899507346462996793, 0.0000000000000073123015405903344311339790100723,
  -0.0000000000000001207274833054326552923951419279,     0.000000000000000196873709350078631599744955052,  0.0000000000000041800528716972082329846809930122,   0.0000000000000069226811716550204129124212813539,  6.4660530738666937011771551624406, -0.0000000000000089972469748791707334854757329329, -5.2740447756471224849406098655891, -0.000000000000002476053845736535140451115077939,  -1.7539776087022702633078097278485, 0.0000000000000020866500486282747061915185655186,
 0.000000000000000062355620544931188781888972087588,   0.00000000000000063588652397425589844199699993393, -0.0000000000000096440697577094127760484830982107,  -0.0000000000000014224416985772982180340145181613, -5.2740447756470922868743400613312,   0.000000000000021899681954914671830283260401835,  6.4660530738667274519571037671994,  0.000000000000017463794040616845634158438588998,  -1.7539776087022647121926866020658,  0.000000000000011984058368475721567962992782448
 },
    .C1 = { 
 0.00000033971074277234365405757983598367, -0.00000016676411799277623980292920187474, 0.00000021931811884842955580393532733635, 0.00000021431590663456913329335462234382,
-0.00000016676411799277629274248840526851,  0.00000033971074277231691958018212212922, 0.00000021431590663454917507953494289208, 0.00000021931811884838696592855619704743,
  0.0000002193181188484291058176820984893,  0.00000021431590663454880450262051913568,  0.0000042275578791547734275931696990014, -0.0000024676003878931425833702026362282,
 0.00000021431590663456945093070984270645,  0.00000021931811884838749532414823098514, -0.0000024676003878931400422713608733272,  0.0000042275578791547403933082267812882
 },
    .C2 = { 
  0,   0.00000000000000029631679789888045220198606185348,   0, 0.00000000000000037550160401918206495831740580919,   0, -0.0000000000000004044558210797089730586017511933,   0,  -0.000000000000002251342449206648078148225365086,   0, -0.00000000000000036500040995499562331285926764479,
1.0, -0.000000000000000075335742287353973860342375097188,   0, -0.0000000000000052045007009395135536049148747226,   0, 0.00000000000000010348353009192301558675106067416,   0, -0.0000000000000016320163621539489133936255080096,   0,   0.0000000000000062180320431878691717543541110477,
  0,     0.000000000000003146145501325988087893323663381,   0,    0.00000000000013366003715925642106359259919695,   0,  -0.000000000000041564404127171784498416585011923,   0,   0.000000000000026418458286075824897572954985593,   0,   -0.000000000000040153019029286571945503114951521,
  0,   -0.0000000000000064998125976838678268206389890942, 1.0,  -0.000000000000057078225117607251432622210788357,   0,  -0.000000000000027462948260349742867005665208511,   0,   0.000000000000074349198143060908901908310870526,   0,    0.000000000000039607874865494746284892556421248,
  0,                   2.9905302279066479087532570702024,   0,           -0.000014096837452015620328893419355154,   0,               0.014885024436850358142692130059004,   0,               0.014710794297871032654256850946695,   0,               0.0028177792617718466772203100845218,
  0,    -0.000000000000071515810919301180685227064677709,   0,   0.000000000000036260023406354783060656618168789, 1.0,    0.00000000000047194439563790062422866256172023,   0,    0.00000000000017222459388987490718144343728419,   0,    0.000000000000079214087168207245983627020724729,
  0,                   2.9905302279066479087532570702024,   0,            0.000014096836105537136063503567129374,   0,               0.014710794297867479940578050445765,   0,               0.014885024436864568997407332062721,   0,               0.0028177792617984920298113138414919,
  0,    -0.000000000000062653825229367154455985340841508,   0,   0.000000000000018749007372334705847774437256918,   0,    0.00000000000037289828826482962959207594680331, 1.0,    0.00000000000018152131025292783674150976986685,   0,    0.000000000000096987850746737910960339093066415,
  0,                   0.9945526419415433583282037943718,   0,   -0.00000000000012167901393558667307440397596297,   0,              0.0049196081132725942228200999295495,   0,              0.0049196081132779709982338900431387,   0,              0.00094993450694147441026871092617512,
  0,    -0.000000000000038181224805491969091665707914964,   0,  -0.000000000000021834049376238846870432232694336,   0,    0.00000000000020290798602773454435314330975658,   0,    0.00000000000012165277941974819478065992037056, 1.0,     0.00000000000009607793103439010031863639767399
},
    .Q = { 
350.0,     0,      0,   0,      0,     0,      0,     0,      0,   0,
    0, 250.0,      0,   0,      0,     0,      0,     0,      0,   0,
    0,     0, 5000.0,   0,      0,     0,      0,     0,      0,   0,
    0,     0,      0, 1.0,      0,     0,      0,     0,      0,   0,
    0,     0,      0,   0, 1000.0,     0,      0,     0,      0,   0,
    0,     0,      0,   0,      0, 800.0,      0,     0,      0,   0,
    0,     0,      0,   0,      0,     0, 1000.0,     0,      0,   0,
    0,     0,      0,   0,      0,     0,      0, 800.0,      0,   0,
    0,     0,      0,   0,      0,     0,      0,     0, 5000.0,   0,
    0,     0,      0,   0,      0,     0,      0,     0,      0, 1.0},
    .R = { 
1.0,   0,    0,    0,
  0, 1.0,    0,    0,
  0,   0, 0.25,    0,
  0,   0,    0, 0.25}
};

TinyMPC_Controller ctrl = {0};
float x_ref[N_STATE] = {0,0,0,0,0,0,0,0,0,0};
float x_current[N_STATE] = { 0.0f, 3.5f, 0.0f, 0.0f, 0.25f, 0.0f, -0.25f, 0.0f, 0.3f, 0.0f};
float u[N_INPUT] = {0};

uint8_t task_init(void)
{
    // 初始化控制器
    tinympc_init(&ctrl, &model, 18.0f);
    tinympc_set_reference(&ctrl, x_ref);
}

void task_main()
{
    // 1. 计算控制输入
    tinympc_control(&ctrl, x_current, u);
    
    // 2. 打印当前状态和控制输入
    // mexPrintf("Step %d:\n", step);
    // mexPrintf("  State x9: %.3f\n", x_current[8]);
    // mexPrintf("  Control u: [%.3f, %.3f, %.3f, %.3f]\n", 
    //         u[0], u[1], u[2], u[3]);
    
    // 3. 更新状态（模拟传感器数据）
    tinympc_state_update(x_current, ctrl.model.A, ctrl.model.B, u, 0.005f);

}